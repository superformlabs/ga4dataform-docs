"use strict";(self.webpackChunkga_4_dataform=self.webpackChunkga_4_dataform||[]).push([[437],{7269:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>t,metadata:()=>o,toc:()=>d});var i=s(4848),r=s(8453);const t={title:"Transaction Model",description:"Information about Transaction model",sidebar_position:4,slug:"/transaction-model-references"},c=void 0,o={id:"references/transaction-model-references",title:"Transaction Model",description:"Information about Transaction model",source:"@site/docs/4-references/4-transaction-model-references.md",sourceDirName:"4-references",slug:"/transaction-model-references",permalink:"/docs/transaction-model-references",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/4-references/4-transaction-model-references.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"Transaction Model",description:"Information about Transaction model",sidebar_position:4,slug:"/transaction-model-references"}},l={},d=[{value:"Design &amp; Features",id:"design--features",level:2},{value:"Config options",id:"config-options",level:2}];function a(e){const n={code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"This page is work in progress"}),"\n",(0,i.jsx)(n.h2,{id:"design--features",children:"Design & Features"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["have a 1 row per transaction table","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["incremental appending (INT) - built from ",(0,i.jsx)(n.code,{children:"ga4_events"})]}),"\n",(0,i.jsxs)(n.li,{children:["full scan for functions that are outside the increment window (OUTPUT)","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"deduplication (optional)"}),"\n",(0,i.jsx)(n.li,{children:"refund aggregation"}),"\n",(0,i.jsx)(n.li,{children:"running customer totals"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"nested: items (1 transaction can have multiple items)"}),"\n",(0,i.jsxs)(n.li,{children:["nested: refunds (1 transaction can have multiple refunds)","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["a refund row is basically the same as a transaction row: 1 row per refund","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"nested: the refunded items"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"aggregated: transaction metrics, item metrics, refund metrics"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"config-options",children:"Config options"}),"\n",(0,i.jsx)(n.p,{children:"Defaults:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'  // by default, we leave duplicate transaction_ids alone, but you can deduplicate here  \n  // note: setting this to true will still keep all transactions with NULL transaction_id  \n  TRANSACTIONS_DEDUPE: false,  \n\n  // we keep a running count for transactions, based on an identifier. Defaults to "user_pseudo_id"  \n  // if you have another one, you can change it here (e.g. "user_id" - make sure it\'s a valid column)  \n  TRANSACTION_TOTALS_UID: \'user_pseudo_id\',  \n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"TRANSACTIONS_DEDUPE` is used in **definitions/core/03_outputs/ga4_transactions.sqlx**  \n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["column ",(0,i.jsx)(n.code,{children:"duplicate_count"})," is ",(0,i.jsx)(n.code,{children:"1"})," if not duplicate, or ",(0,i.jsx)(n.code,{children:"2"}),", ",(0,i.jsx)(n.code,{children:"3"}),", etc if duplicate ",(0,i.jsx)(n.code,{children:"transaction_id"})," found"]}),"\n",(0,i.jsxs)(n.li,{children:["if ",(0,i.jsx)(n.code,{children:"TRANSACTIONS_DEDUPE"})," is ",(0,i.jsx)(n.code,{children:"true"}),", then only the 1st transaction ID ends up in the table","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["via helper function ",(0,i.jsx)(n.code,{children:"generateTransactionsDedupeSQL"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"TRANSACTION_TOTALS_UID"})," is used like this:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["a column is SELECTed from ",(0,i.jsx)(n.code,{children:"ga4_events"})," and added to ",(0,i.jsx)(n.strong,{children:"definitions/core/02_intermediate/int_ga4_transactions.sqlx"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["this can be any column of the events table.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"user_pseudo_id"})," \u2190 default"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"user_id"})," (a logical choice)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"event_params_custom.email_hash"})," \u2190 super custom"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"coalesce(user_id, user_pseudo_id)"})," \u2190 super power user trick"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"${config.TRANSACTION_TOTALS_UID} as uid"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["in ",(0,i.jsx)(n.strong,{children:"definitions/core/03_outputs/ga4_transactions.sqlx"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"fill running totals column"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"struct(  \n    if( uid is null, null, row_number() over user ) as transactions,   \n    if( uid is null, null, sum(ecommerce.purchase_revenue) over user ) as purchase_revenue,  \n    ...  \n) as running_totals,  \nwindow user as ( partition by uid order by time.event_timestamp )  \n"})})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>o});var i=s(6540);const r={},t=i.createContext(r);function c(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);